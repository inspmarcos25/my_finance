<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://nlcvurffexmcsccbkeci.supabase.co; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://nlcvurffexmcsccbkeci.supabase.co; font-src 'self' data:;">
  <title>Rastreador de Despesas</title>
  <link rel="stylesheet" href="/style.css">
  <script>
    // Verificar autenticaÃ§Ã£o ANTES de carregar a pÃ¡gina
    (function() {
      const fromLogin = sessionStorage.getItem('from_login');
      if (!fromLogin) {
        window.location.replace('/login.html');
      }
    })();
  </script>
</head>
<body>
  <button 
    id="logoutBtnMobile"
    class="btn-logout mobile-logout"
    title="Sair"
    aria-label="Sair"
    data-logout
  >ğŸšª</button>
  <div class="container">
    <!-- Modal de EdiÃ§Ã£o -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>âœï¸ Editar TransaÃ§Ã£o</h2>
          <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm" class="form">
          <div class="form-group">
            <label for="editDescription">DescriÃ§Ã£o</label>
            <input 
              type="text" 
              id="editDescription" 
              name="description" 
              required
              placeholder="Ex: AlmoÃ§o no restaurante"
            >
          </div>

          <div class="form-group">
            <label for="editAmount">Valor (R$)</label>
            <input 
              type="number" 
              id="editAmount" 
              name="amount" 
              required 
              step="0.01"
              min="0"
              placeholder="0,00"
            >
          </div>

          <div class="form-group">
            <label for="editType">Tipo</label>
            <select id="editType" name="type" required>
              <option value="">Selecione um tipo</option>
              <option value="entrada">Entrada</option>
              <option value="saida">SaÃ­da</option>
            </select>
          </div>

          <div class="form-group">
            <label for="editCategory">Categoria</label>
            <select id="editCategory" name="category_id" required>
              <option value="">Selecione uma categoria</option>
            </select>
          </div>

          <div class="form-group">
            <label for="editDate">Data</label>
            <input 
              type="date" 
              id="editDate" 
              name="date" 
              required
            >
          </div>

          <div class="recurrence-card" data-recurrence-group="edit">
            <div class="recurrence-header">
              <div>
                <p class="eyebrow">RecorrÃªncia</p>
                <h4>Marcar como recorrente</h4>
                <p class="muted">Sincronize a periodicidade sem sair do modo de ediÃ§Ã£o.</p>
              </div>
              <span class="pill pill-soft">Recorrente</span>
            </div>

            <input type="hidden" name="recurrence_type" value="nenhuma" data-recurrence-input>

            <div class="pill-group" data-recurrence-pills>
              <button type="button" class="pill active" data-recurrence="nenhuma">Ãšnica</button>
              <button type="button" class="pill" data-recurrence="semanal">Semanal</button>
              <button type="button" class="pill" data-recurrence="mensal">Mensal</button>
              <button type="button" class="pill" data-recurrence="anual">Anual</button>
            </div>

            <div class="recurrence-meta">
              <label for="editRecurrenceUntil">Fim da recorrÃªncia (opcional)</label>
              <input 
                type="date" 
                id="editRecurrenceUntil" 
                name="recurrence_until" 
                data-recurrence-until
              >
              <p class="hint">Se vazio, mantÃ©m a recorrÃªncia ativa.</p>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
              âœ• Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              ğŸ’¾ Salvar AlteraÃ§Ãµes
            </button>
          </div>
        </form>
      </div>
    </div>
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>ğŸ’° Despesas</h1>
        <div class="user-info">
          <span id="userEmail"></span>
          <button id="logoutBtn" class="btn-logout desktop-logout" title="Sair" data-logout>ğŸšª</button>
        </div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-btn active" data-view="dashboard" title="Dashboard">
          ğŸ“Š<span>Dashboard</span>
        </button>
        <button class="nav-btn" data-view="transactions" title="TransaÃ§Ãµes">
          ğŸ“‹<span>TransaÃ§Ãµes</span>
        </button>
        <button class="nav-btn" data-view="add-transaction" title="Nova TransaÃ§Ã£o">
          â•<span>Nova</span>
        </button>
        <button class="nav-btn" data-view="categories" title="Categorias">
          ğŸ·ï¸<span>Categorias</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard View -->
      <section class="view active" id="dashboard">
        <h2>Dashboard</h2>
        
        <div class="balance-cards">
          <div class="card balance-card total">
            <div class="card-label">Saldo Total</div>
            <div class="card-value" id="totalBalance">R$ 0,00</div>
          </div>
          <div class="card balance-card income">
            <div class="card-label">Entradas</div>
            <div class="card-value" id="totalIncome">R$ 0,00</div>
          </div>
          <div class="card balance-card expense">
            <div class="card-label">SaÃ­das</div>
            <div class="card-value" id="totalExpense">R$ 0,00</div>
          </div>
        </div>

        <div class="card">
          <h3>Gastos por Categoria</h3>
          <div id="categoryChart" class="category-chart"></div>
        </div>

        <div class="card">
          <h3>Ãšltimas TransaÃ§Ãµes</h3>
          <div id="recentTransactions" class="transactions-list"></div>
        </div>
      </section>

      <!-- Transactions View -->
      <section class="view" id="transactions">
        <h2>TransaÃ§Ãµes</h2>
        
        <div class="filters">
          <select id="filterType">
            <option value="">Todos os tipos</option>
            <option value="entrada">Entradas</option>
            <option value="saida">SaÃ­das</option>
          </select>
          <select id="filterCategory">
            <option value="">Todas as categorias</option>
          </select>
        </div>

        <div class="charts-grid">
          <div class="card">
            <h3>ğŸ“Š Despesas por Categoria</h3>
            <div class="chart-container">
              <canvas id="categoryPieChart"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>ğŸ“ˆ Entradas vs SaÃ­das</h3>
            <div class="chart-container">
              <canvas id="incomeExpenseChart"></canvas>
            </div>
          </div>
        </div>
        <div id="transactionsList" class="transactions-list"></div>
      </section>

      <!-- Add Transaction View -->
      <section class="view" id="add-transaction">
        <h2>Nova TransaÃ§Ã£o</h2>
        
        <form id="transactionForm" class="form">
          <div class="form-group">
            <label for="transDescription">DescriÃ§Ã£o</label>
            <input 
              type="text" 
              id="transDescription" 
              name="description" 
              required
              placeholder="Ex: AlmoÃ§o no restaurante"
            >
          </div>

          <div class="form-group">
            <label for="transAmount">Valor (R$)</label>
            <input 
              type="number" 
              id="transAmount" 
              name="amount" 
              required 
              step="0.01"
              min="0"
              placeholder="0,00"
            >
          </div>

          <div class="form-group">
            <label for="transType">Tipo</label>
            <select id="transType" name="type" required>
              <option value="">Selecione um tipo</option>
              <option value="entrada">Entrada</option>
              <option value="saida">SaÃ­da</option>
            </select>
          </div>

          <div class="form-group">
            <label for="transCategory">Categoria</label>
            <select id="transCategory" name="category_id" required>
              <option value="">Selecione uma categoria</option>
            </select>
          </div>

          <div class="form-group">
            <label for="transDate">Data</label>
            <input 
              type="date" 
              id="transDate" 
              name="date" 
              required
            >
          </div>

          <div class="recurrence-card" data-recurrence-group="create">
            <div class="recurrence-header">
              <div>
                <p class="eyebrow">RecorrÃªncia</p>
                <h4>Transforme em receita ou despesa recorrente</h4>
                <p class="muted">Escolha a frequÃªncia e, se quiser, defina quando parar.</p>
              </div>
              <span class="pill pill-soft">Novo</span>
            </div>

            <input type="hidden" name="recurrence_type" value="nenhuma" data-recurrence-input>

            <div class="pill-group" data-recurrence-pills>
              <button type="button" class="pill active" data-recurrence="nenhuma">Ãšnica</button>
              <button type="button" class="pill" data-recurrence="semanal">Semanal</button>
              <button type="button" class="pill" data-recurrence="mensal">Mensal</button>
              <button type="button" class="pill" data-recurrence="anual">Anual</button>
            </div>

            <div class="recurrence-meta">
              <label for="transRecurrenceUntil">Fim da recorrÃªncia (opcional)</label>
              <input 
                type="date" 
                id="transRecurrenceUntil" 
                name="recurrence_until" 
                data-recurrence-until
              >
              <p class="hint">Deixe vazio para continuar atÃ© vocÃª parar manualmente.</p>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">
            â• Adicionar TransaÃ§Ã£o
          </button>
        </form>
      </section>

      <!-- Categories View -->
      <section class="view" id="categories">
        <h2>Categorias</h2>
        
        <form id="categoryForm" class="form">
          <div class="form-group">
            <label for="catName">Nome</label>
            <input 
              type="text" 
              id="catName" 
              name="name" 
              required
              placeholder="Ex: DiversÃ£o"
            >
          </div>

          <div class="form-group">
            <label for="catIcon">Ãcone</label>
            <input 
              type="text" 
              id="catIcon" 
              name="icon" 
              placeholder="Ex: ğŸ®"
            >
          </div>

          <div class="form-group">
            <label for="catColor">Cor</label>
            <input 
              type="color" 
              id="catColor" 
              name="color"
            >
          </div>

          <button type="submit" class="btn btn-primary">
            â• Adicionar Categoria
          </button>
        </form>

        <div id="categoriesList" class="categories-grid"></div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/script.js?v=2"></script>
</body>
</html>
